<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flipbook Interaktif - Demo</title>

  <!-- CSS sederhana -->
  <style>
    body { font-family: Arial, sans-serif; margin: 8px; background:#f6f6f6; }
    #flipbook { width: 900px; height: 650px; margin: 20px auto; }
    .page { width: 450px; height: 650px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.2); background: white; display:flex; align-items:center; justify-content:center; position:relative; }
    .page canvas { max-width:100%; height:auto; display:block; }

    /* tombol di halaman */
    .open-question-btn {
      position: absolute; bottom: 20px; left: 20px;
      padding: 8px 12px; border-radius:6px; background:#007bff; color:white; border:none; cursor:pointer;
    }

    /* Modal soal */
    #questionModal { display:none; position: fixed; left:0; top:0; right:0; bottom:0; background: rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:9999; }
    .modal-inner { width: 420px; background: #fff; padding: 16px; border-radius:8px; box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
    .modal-inner h3 { margin-top:0; }
    .modal-inner textarea { width:100%; height:90px; resize:none; padding:8px; font-size:14px; }
    .modal-inner input[type=text] { width:100%; padding:6px; margin-bottom:6px; }
    .modal-actions { text-align:right; margin-top:8px; }
    .modal-actions button { padding:8px 12px; margin-left:6px; border-radius:6px; cursor:pointer; }
    .btn-belum { background:#ccc; border:none; }
    .btn-lanjut { background:#28a745; color:#fff; border:none; }

    /* responsive */
    @media (max-width:1000px) {
      #flipbook { width: 100%; height: 60vh; }
      .page { height: 60vh; }
    }
  </style>
</head>
<body>

  <h2 style="text-align:center">Flipbook Interaktif (contoh)</h2>

  <div id="flipbook"></div>

  <!-- Modal soal -->
  <div id="questionModal">
    <div class="modal-inner">
      <h3>Soal â€” Halaman 10</h3>
      <label>Nama (opsional)</label>
      <input type="text" id="studentName" placeholder="Nama siswa...">
      <label>Jawaban (maks 100 karakter)</label>
      <textarea id="answer" maxlength="100" placeholder="Tulis jawaban di sini (max 100 karakter)"></textarea>
      <div style="color:#666; font-size:12px; margin-top:6px;">*Jawaban akan tersimpan ke Google Spreadsheet.</div>
      <div class="modal-actions">
        <button class="btn-belum" id="btnBelum">Belum</button>
        <button class="btn-lanjut" id="btnLanjut">Lanjut</button>
      </div>
      <div id="modalStatus" style="margin-top:8px; font-size:13px; color:#333;"></div>
    </div>
  </div>

  <!-- LIBRARIES -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- PDF.js (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <!-- worker -->
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
  </script>

  <!-- Turn.js: letakkan file js/turn.min.js di folder js/turn.min.js atau gunakan link yang Anda download -->
  <script src="js/turn.min.js"></script>

  <script>
  (function(){
    // ========== CONFIG ==========
    const FILE_ID = '1zCZsbD6vijTXsamfkYhSkWynEfLsn3Nb'; // << ganti kalau perlu
    const PDF_URL = `https://drive.google.com/uc?export=download&id=${FILE_ID}`;
    const APPSCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzylDDd-dZIikHV3kPTsNY-yJ3bcJapuuxl020QJ_byEp9_w4fuIhvzpDhhSGBxb6Cz/exec'; // << ganti dengan URL Web App Anda

    // halaman kunci: setelah jawab halaman 10, baru bisa ke 11
    const lockPage = 10;
    let maxUnlockedPage = lockPage; // awal hanya sampai halaman 10 terbuka
    let answeredPages = {}; // answeredPages[10] = true jika sudah submit
    // ============================

    // load PDF
    pdfjsLib.getDocument(PDF_URL).promise.then(async function(pdf) {
      const total = pdf.numPages;
      let rendered = 0;

      for (let p=1; p<=total; p++) {
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({ scale: 1.5 }); // ubah scale jika mau ukuran lain
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const ctx = canvas.getContext('2d');

        await page.render({ canvasContext: ctx, viewport: viewport }).promise;

        // bungkus canvas dalam div.page
        const pageDiv = document.createElement('div');
        pageDiv.className = 'page';
        pageDiv.dataset.pagenumber = p;
        pageDiv.appendChild(canvas);

        // kalau halaman 10 --> tambahkan tombol buka soal
        if (p === lockPage) {
          const btn = document.createElement('button');
          btn.className = 'open-question-btn';
          btn.textContent = 'Buka Pertanyaan';
          btn.onclick = showQuestionModal;
          pageDiv.appendChild(btn);
        }

        document.getElementById('flipbook').appendChild(pageDiv);
        rendered++;

        // kalau seluruh halaman sudah dirender, init flipbook
        if (rendered === total) initFlipbook();
      }
    }).catch(function(err){
      alert('Gagal memuat PDF. Pastikan file Drive diset "Anyone with link can view".\nError: '+err.message);
    });

    function initFlipbook() {
      // inisialisasi turn.js
      $("#flipbook").turn({
        width: 900,
        height: 650,
        autoCenter: true
      });

      // event - cegah membuka halaman > maxUnlockedPage
      $("#flipbook").bind("turning", function(e, page, view) {
        const current = $("#flipbook").turn("page"); // halaman sekarang
        if (page > maxUnlockedPage) {
          // batalkan dengan mengembalikan ke halaman sekarang
          setTimeout(function(){ $("#flipbook").turn("page", current); }, 1);
          // munculkan modal soal
          showQuestionModal();
        }
      });
    }

    // Modal controls
    function showQuestionModal(){
      document.getElementById('modalStatus').textContent = '';
      document.getElementById('questionModal').style.display = 'flex';
      document.getElementById('answer').value = '';
      document.getElementById('studentName').value = '';
      document.getElementById('answer').focus();
    }
    function hideQuestionModal(){
      document.getElementById('questionModal').style.display = 'none';
    }

    document.getElementById('btnBelum').addEventListener('click', function(){
      hideQuestionModal();
    });

    document.getElementById('btnLanjut').addEventListener('click', function(){
      const nama = document.getElementById('studentName').value.trim();
      const jawaban = document.getElementById('answer').value.trim();

      if (jawaban.length === 0) {
        alert('Mohon isi jawaban terlebih dahulu.');
        return;
      }
      if (jawaban.length > 100) {
        alert('Jawaban maksimal 100 karakter.');
        return;
      }

      // kirim ke Apps Script Web App
      const payload = { nama: nama, halaman: lockPage, jawaban: jawaban };
      document.getElementById('modalStatus').textContent = 'Mengirim...';

      fetch(APPSCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.result && data.result === 'ok') {
          document.getElementById('modalStatus').textContent = 'Terkirim. Halaman berikutnya terbuka.';
          answeredPages[lockPage] = true;
          maxUnlockedPage = Math.max(maxUnlockedPage, lockPage + 1);
          hideQuestionModal();
          // buka halaman selanjutnya
          setTimeout(function(){ $("#flipbook").turn("page", lockPage + 1); }, 150);
        } else {
          document.getElementById('modalStatus').textContent = 'Gagal mengirim (server error). Coba lagi.';
          console.error(data);
        }
      })
      .catch(err => {
        document.getElementById('modalStatus').textContent = 'Gagal mengirim: ' + err.message;
        console.error(err);
      });
    });

  })();
  </script>
</body>
</html>
